name: Build and Deploy Backend to EKS

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    name: Build and Push Backend Image to ECR
    runs-on: ubuntu-latest
    outputs:
      IMAGE_TAG: ${{ steps.set_image_tag.outputs.IMAGE_TAG }}
      SKIP_BUILD: ${{ steps.check_backend_changes.outputs.SKIP_BUILD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes in backend-application
        id: check_backend_changes
        run: |
          if git diff --quiet HEAD^ HEAD -- backend-application/; then
            echo "No changes in backend-application"
            echo "SKIP_BUILD=true" >> $GITHUB_ENV
            echo "SKIP_BUILD=true" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in backend-application"
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
            echo "SKIP_BUILD=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate image tag
        if: env.SKIP_BUILD == 'false'
        id: set_image_tag
        run: |
          IMAGE_TAG=$(date +%Y%m%d%H%M%S)
          echo "$IMAGE_TAG" > image-tag.txt
          echo "Generated IMAGE_TAG: $IMAGE_TAG"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Upload IMAGE_TAG as Artifact
        if: env.SKIP_BUILD == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: image-tag
          path: image-tag.txt

      - name: Build Backend Docker Image
        if: env.SKIP_BUILD == 'false'
        run: |
          IMAGE_TAG=$(cat image-tag.txt)
          docker build -t ${{ secrets.ECR_REGISTRY_BE }}:$IMAGE_TAG ./backend-application

      - name: Push Backend Docker Image to ECR
        if: env.SKIP_BUILD == 'false'
        run: |
          IMAGE_TAG=$(cat image-tag.txt)
          docker push ${{ secrets.ECR_REGISTRY_BE }}:$IMAGE_TAG

  deploy:
    name: Deploy Backend to Kubernetes
    runs-on: ubuntu-latest
    needs: build-and-push
    env:
      SKIP_BUILD: ${{ needs.build-and-push.outputs.SKIP_BUILD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download IMAGE_TAG Artifact
        if: env.SKIP_BUILD == 'false'
        uses: actions/download-artifact@v4
        with:
          name: image-tag

      - name: Load IMAGE_TAG
        run: |
          if [ "$SKIP_BUILD" == "false" ]; then
            IMAGE_TAG=$(cat image-tag.txt)
          else
            echo "SKIP_BUILD=true. Obtendo última tag do Helm..."
            IMAGE_TAG=$(helm get values backend -n default -o yaml | grep 'tag:' | awk '{print $2}')
          fi

          if [ -z "$IMAGE_TAG" ]; then
            echo "Erro: IMAGE_TAG está vazia. Abortando..."
            exit 1
          fi

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "Usando IMAGE_TAG: $IMAGE_TAG"

      - name: Check for changes in Helm Charts
        id: check_helm_changes
        run: |
          if git diff --quiet HEAD^ HEAD -- helm-charts/; then
            echo "No changes in Helm Charts"
            echo "SKIP_DEPLOY=true" >> $GITHUB_ENV
          else
            echo "Changes detected in Helm Charts"
            echo "SKIP_DEPLOY=false" >> $GITHUB_ENV
          fi

      - name: Configure AWS Credentials
        if: env.SKIP_DEPLOY == 'false' || env.SKIP_BUILD == 'false'
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Configure kubectl
        if: env.SKIP_DEPLOY == 'false' || env.SKIP_BUILD == 'false'
        run: |
          aws eks update-kubeconfig --region ${{ secrets.AWS_REGION }} --name ${{ secrets.EKS_CLUSTER_NAME }}

      - name: Check if Helm Release Exists
        id: check_helm_release
        run: |
          RELEASE_NAME="backend"
          NAMESPACE="default"

          if helm status $RELEASE_NAME -n $NAMESPACE > /dev/null 2>&1; then
            echo "HELM_RELEASE_EXISTS=true" >> $GITHUB_ENV
          else
            echo "HELM_RELEASE_EXISTS=false" >> $GITHUB_ENV
          fi

      - name: Deploy Backend to EKS using Helm
        if: env.SKIP_DEPLOY == 'false' || env.SKIP_BUILD == 'false' || env.HELM_RELEASE_EXISTS == 'false'
        run: |
          RELEASE_NAME="backend"
          NAMESPACE="default"

          echo "Verificando release Helm..."
          echo "HELM_RELEASE_EXISTS=${HELM_RELEASE_EXISTS}"
          echo "Deploying IMAGE_TAG: $IMAGE_TAG"

          if [ "$HELM_RELEASE_EXISTS" = "true" ]; then
            echo "A release '$RELEASE_NAME' já existe. Aplicando upgrade..."
            helm upgrade $RELEASE_NAME ./helm-charts/nginx-chart \
              --namespace $NAMESPACE \
              --set image.repository=${{ secrets.ECR_REGISTRY_BE }} \
              --set image.tag=$IMAGE_TAG
          else
            echo "A release '$RELEASE_NAME' não existe. Instalando..."
            helm install $RELEASE_NAME ./helm-charts/nginx-chart \
              --namespace $NAMESPACE \
              --set image.repository=${{ secrets.ECR_REGISTRY_BE }} \
              --set image.tag=$IMAGE_TAG
          fi

name: Build and Deploy Backend to EKS

on:
  push:
    branches:
      - main  # Roda quando algo for alterado na branch main

jobs:
  build-and-push:
    name: Build and Push Backend Image to ECR
    runs-on: ubuntu-latest
    outputs:
      IMAGE_TAG: ${{ steps.set_image_tag.outputs.IMAGE_TAG }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Garantir que temos hist칩rico para diff

      # 游댳 Verifica se houve mudan칞as na aplica칞칚o (backend-application)
      - name: Check for changes in backend-application
        id: check_backend_changes
        run: |
          if git diff --quiet HEAD^ HEAD -- backend-application/; then
            echo "No changes in backend-application"
            echo "SKIP_BUILD=true" >> $GITHUB_ENV
          else
            echo "Changes detected in backend-application"
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
          fi

      - name: Configure AWS Credentials
        if: env.SKIP_BUILD == 'false'
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        if: env.SKIP_BUILD == 'false'
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | \
          docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY_BE }}

      - name: Generate image tag
        if: env.SKIP_BUILD == 'false'
        id: set_image_tag
        run: |
          IMAGE_TAG=$(date +%Y%m%d%H%M%S)
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Build Backend Docker Image
        if: env.SKIP_BUILD == 'false'
        run: |
          docker build -t ${{ secrets.ECR_REGISTRY_BE }}:${{ env.IMAGE_TAG }} ./backend-application

      - name: Push Backend Docker Image to ECR
        if: env.SKIP_BUILD == 'false'
        run: |
          docker push ${{ secrets.ECR_REGISTRY_BE }}:${{ env.IMAGE_TAG }}

  deploy:
    name: Deploy Backend to Kubernetes
    runs-on: ubuntu-latest
    needs: build-and-push
    env:
      IMAGE_TAG: ${{ needs.build-and-push.outputs.IMAGE_TAG }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Garantir que temos hist칩rico para diff

      # 游댳 Verifica se houve mudan칞as no Helm Chart
      - name: Check for changes in Helm Charts
        id: check_helm_changes
        run: |
          if git diff --quiet HEAD^ HEAD -- helm-charts/; then
            echo "No changes in Helm Charts"
            echo "SKIP_DEPLOY=true" >> $GITHUB_ENV
          else
            echo "Changes detected in Helm Charts"
            echo "SKIP_DEPLOY=false" >> $GITHUB_ENV
          fi

      - name: Configure AWS Credentials
        if: env.SKIP_DEPLOY == 'false' || env.SKIP_BUILD == 'false'
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Configure kubectl
        if: env.SKIP_DEPLOY == 'false' || env.SKIP_BUILD == 'false'
        run: |
          aws eks update-kubeconfig --region ${{ secrets.AWS_REGION }} --name ${{ secrets.EKS_CLUSTER_NAME }}

      # 游댳 Verifica se a release do Helm j치 existe no cluster
      - name: Check if Helm Release Exists
        id: check_helm_release
        run: |
          RELEASE_NAME="backend"
          NAMESPACE="default"

          if helm status $RELEASE_NAME -n $NAMESPACE > /dev/null 2>&1; then
            echo "HELM_RELEASE_EXISTS=true" >> $GITHUB_ENV
          else
            echo "HELM_RELEASE_EXISTS=false" >> $GITHUB_ENV
          fi

      # 游댳 Garante que IMAGE_TAG est치 definida antes de fazer o deploy
      - name: Ensure IMAGE_TAG is set
        run: |
          if [ -z "$IMAGE_TAG" ]; then
            echo "Erro: IMAGE_TAG est치 vazia. Abortando..."
            exit 1
          fi

      # 游댳 Executa o deploy se houver mudan칞as ou se a release n칚o existir
      - name: Deploy Backend to EKS using Helm
        if: env.SKIP_DEPLOY == 'false' || env.SKIP_BUILD == 'false' || env.HELM_RELEASE_EXISTS == 'false'
        run: |
          RELEASE_NAME="backend"
          NAMESPACE="default"

          echo "Verificando release Helm..."
          echo "HELM_RELEASE_EXISTS=${HELM_RELEASE_EXISTS}"

          if [ "$HELM_RELEASE_EXISTS" = "true" ]; then
            echo "A release '$RELEASE_NAME' j치 existe. Aplicando upgrade..."
            helm upgrade $RELEASE_NAME ./helm-charts/nginx-chart \
              --namespace $NAMESPACE \
              --set image.repository=${{ secrets.ECR_REGISTRY_BE }} \
              --set image.tag=$IMAGE_TAG
          else
            echo "A release '$RELEASE_NAME' n칚o existe. Instalando..."
            helm install $RELEASE_NAME ./helm-charts/nginx-chart \
              --namespace $NAMESPACE \
              --set image.repository=${{ secrets.ECR_REGISTRY_BE }} \
              --set image.tag=$IMAGE_TAG
          fi
